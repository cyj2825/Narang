pipeline {
    agent any
    tools {nodejs "nodejs-21.6.1"}

    environment {
        releaseServerAccount = 'ubuntu'
        releaseServerUri = 'i10a701.p.ssafy.io'
    }
    stages {
        stage('Checkout') {
            steps {
                // 소스 코드 체크아웃
                checkout scm
            }
        }
        stage('node Build') {
            steps {
                script {
                    // npm 이용 frontend 프로젝트 빌드
                    dir("frontend/") {
                        sh "npm install"
                        // package.json 기반 필요 모듈 설치
                        sh "npm run build"
                        // 빌드
                    }

                }
            }
        }
        stage('Docker Image Build') {
            steps {
                // 도커 컨테이너 있으면 삭제 없으면 그냥 실행
                sh '(docker stop frontend && docker rm frontend) | true'
                // 
                sh 'docker build -t frontend -f ./frontend/Dockerfile .'
                // 배포 스크립트 실행 (예: Docker 컨테이너에 배포)
                sh 'docker run --name frontend --network Narang -p 3000:3716 -d frontend'
                
                // 도커 nginx 재시작
                sh 'docker restart nginx'
            }
        }
    }
}
